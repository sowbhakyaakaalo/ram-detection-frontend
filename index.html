<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAM Slot Detection</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f9f9f9;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .tab-container {
      margin-top: 40px;
    }
    .tab-btns {
      display: flex;
      border-bottom: 2px solid #dee2e6;
    }
    .tab-btn {
      flex: 1;
      padding: 10px;
      text-align: center;
      background-color: #ffffff;
      cursor: pointer;
      font-weight: 500;
      border-bottom: 4px solid transparent;
    }
    .tab-btn.active {
      color: #198754;
      border-bottom: 4px solid #198754;
    }
    .tab-content {
      display: none;
      margin-top: 20px;
    }
    .tab-content.active {
      display: block;
    }
    #canvasPreview {
      width: 100%;
      height: auto;
      background-color: black;
    }
    #uploadedResult {
      width: 100%;
      max-height: 500px;
      object-fit: contain;
      border: 2px solid #198754;
      margin-top: 15px;
    }
    .example-gallery img {
      max-width: 120px;
      border-radius: 8px;
      margin: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h2 class="text-center text-success mb-3">ðŸ’» RAM Slot Detection</h2>

    <div class="tab-container">
      <div class="tab-btns">
        <div class="tab-btn active" data-tab="upload">ðŸ–¼ Upload Module</div>
        <div class="tab-btn" data-tab="camera">ðŸ“· Camera</div>
      </div>

      <div class="tab-content active" id="upload">
        <input type="file" id="imageUpload" accept="image/*" class="form-control mt-3 mb-3" />
        <img id="uploadedResult" alt="Detection result will appear here" />
        <h5 class="mt-4">Example Laptops:</h5>
        <div class="example-gallery d-flex flex-wrap">
          <img src="assets/laptop1.jpg" alt="Example 1">
          <img src="assets/laptop2.jpg" alt="Example 2">
          <img src="assets/laptop3.jpg" alt="Example 3">
          <img src="assets/laptop4.jpg" alt="Example 4">
        </div>
      </div>

      <div class="tab-content" id="camera">
        <select id="cameraSelect" class="form-select mb-2">
          <option value="environment">Back Camera</option>
          <option value="user">Front Camera</option>
        </select>
        <button id="startBtn" class="btn btn-success">Start Camera</button>
        <canvas id="canvasPreview" class="mt-3"></canvas>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://onnx-api-backend-6.onrender.com/predict/";
    const video = document.createElement('video');
    const canvas = document.getElementById('canvasPreview');
    const ctx = canvas.getContext('2d');
    let stream = null;
    let detectionLocked = false;

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.getAttribute('data-tab')).classList.add('active');
      });
    });

    document.getElementById("imageUpload").addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("file", file);
      try {
        const res = await fetch(API_URL, { method: "POST", body: formData });
        const arrayBuffer = await res.arrayBuffer();
        const imgBlob = new Blob([arrayBuffer], { type: "image/jpeg" });
        const imgURL = URL.createObjectURL(imgBlob);
        document.getElementById("uploadedResult").src = imgURL;
      } catch (err) {
        alert("Error detecting image");
        console.warn(err);
      }
    });

    document.getElementById("startBtn").addEventListener("click", async () => {
      const facingMode = document.getElementById("cameraSelect").value;
      if (stream) stream.getTracks().forEach(track => track.stop());
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode, width: 640, height: 480 }
      });
      video.srcObject = stream;
      video.play();
      detectionLocked = false;
      requestAnimationFrame(processFrame);
    });

    async function processFrame() {
      if (video.readyState === 4 && !detectionLocked) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const frame = canvas.toDataURL("image/jpeg");
        const blob = await (await fetch(frame)).blob();
        const formData = new FormData();
        formData.append("file", blob, "frame.jpg");

        try {
          const res = await fetch(API_URL, { method: "POST", body: formData });
          const arrayBuffer = await res.arrayBuffer();
          const imgBlob = new Blob([arrayBuffer], { type: "image/jpeg" });
          const imgURL = URL.createObjectURL(imgBlob);
          const tempImg = new Image();
          tempImg.src = imgURL;
          tempImg.onload = () => {
            ctx.drawImage(tempImg, 0, 0, canvas.width, canvas.height);
            URL.revokeObjectURL(imgURL);
          };
          detectionLocked = true;
        } catch (err) {
          console.warn("Camera API error", err);
        }
      }
      setTimeout(() => requestAnimationFrame(processFrame), 400);
    }
  </script>
</body>
</html>

